# Placeholder semantic model (draft)
entities:
  - name: user
    grain: user_pseudo_id
    table: `proj.mall.users`
    dimensions:
      - name: user_pseudo_id
      - name: first_touch_date
        type: date
      - name: first_channel
        synonyms: [유입채널, 채널]
      - name: is_new_user
        type: boolean

  - name: session
    grain: session_id
    table: `proj.mall.sessions`
    relationships:
      - to: user
        type: many_to_one
        on: session.user_pseudo_id = user.user_pseudo_id
    dimensions:
      - name: session_id
      - name: session_date
        type: date
      - name: source_medium
      - name: campaign
      - name: device_category
      - name: landing_page
      - name: is_bounce
        type: boolean
    measures:
      - name: sessions
        expr: COUNT(DISTINCT session_id)
      - name: bounces
        expr: SUM(CASE WHEN is_bounce THEN 1 ELSE 0 END)

  - name: event
    grain: event_id
    table: `proj.mall.events`
    relationships:
      - to: session
        type: many_to_one
        on: event.session_id = session.session_id
      - to: user
        type: many_to_one
        on: event.user_pseudo_id = user.user_pseudo_id
    dimensions:
      - name: event_date
        type: date
      - name: event_name
      - name: page_path
      - name: item_id
      - name: event_value
        type: number
    measures:
      - name: events
        expr: COUNT(*)
      - name: add_to_cart
        expr: SUM(CASE WHEN event_name = 'add_to_cart' THEN 1 ELSE 0 END)
      - name: purchases
        expr: SUM(CASE WHEN event_name = 'purchase' THEN 1 ELSE 0 END)

  - name: order
    grain: order_id
    table: `proj.mall.orders`
    relationships:
      - to: user
        type: many_to_one
        on: order.user_pseudo_id = user.user_pseudo_id
      - to: session
        type: many_to_one
        on: order.session_id = session.session_id
    dimensions:
      - name: order_id
      - name: order_date
        type: date
      - name: status
        valid_values: [completed, cancelled, returned]
      - name: payment_method
      - name: channel
    measures:
      - name: orders
        expr: COUNT(DISTINCT order_id)
      - name: gmv
        expr: SUM(net_amount)
      - name: customers
        expr: COUNT(DISTINCT user_pseudo_id)

metrics:
  - name: sessions
    expr: COUNT(DISTINCT session.session_id)
  - name: users
    expr: COUNT(DISTINCT user.user_pseudo_id)
  - name: events
    expr: COUNT(*)
  - name: gmv
    expr: SUM(order.net_amount)
    default_filters: [order.status='completed']
  - name: orders
    expr: COUNT(DISTINCT order.order_id)
    default_filters: [order.status='completed']
  - name: conversion_rate
    expr: SAFE_DIVIDE(COUNT(DISTINCT order.order_id), COUNT(DISTINCT session.session_id))
    default_filters: [order.status='completed']
  - name: aov
    expr: SAFE_DIVIDE(SUM(order.net_amount), NULLIF(COUNT(DISTINCT order.order_id),0))
    default_filters: [order.status='completed']
  - name: bounce_rate
    expr: SAFE_DIVIDE(SUM(CASE WHEN session.is_bounce THEN 1 ELSE 0 END), COUNT(DISTINCT session.session_id))

vocabulary:
  synonyms:
    '구매': ['주문','order','purchase','결제']
    '매출': ['GMV','거래액','매출액']
    '세션': ['방문','session']
    '유입': ['첫방문','first_touch','first_channel']
    '장바구니': ['add_to_cart','장바']
    '이탈률': ['bounce_rate','바운스']
    '전환율': ['conversion','conversion_rate','전환']
  units:
    currency: KRW

# NLU 키워드 설정 (Natural Language Understanding)
nlu_keywords:
  # 의도(Intent) 키워드
  intents:
    comparison:
      - '비교'
      - '대비'
      - 'vs'
      - 'compare'
      - '차이'
    metric_over_time:
      - '추이'
      - 'trend'
      - 'over time'
      - '변화'
      - '흐름'
    aggregation:
      - '별'
      - '그룹'
      - 'group by'
      - '분류'
      - '구분'

  # 메트릭 키워드
  metrics:
    gmv:
      - '매출'
      - 'gmv'
      - '매출액'
      - 'revenue'
      - '거래액'
      - '취급액'
      - '매출금액'
      - '취급금액'
    orders:
      - '주문'
      - 'orders'
      - '주문건수'
      - '주문수'
      - '결제'
    sessions:
      - '세션'
      - '방문'
      - 'sessions'
      - 'visit'
      - '접속'
    users:
      - '사용자'
      - '유저'
      - 'users'
      - '방문자'
      - '고객'
      - '회원'
    events:
      - '이벤트'
      - 'events'
      - '클릭'
      - '액션'

  # 시간 범위 키워드
  time_windows:
    days_7:
      - '지난 7일'
      - '최근 7일'
      - 'last 7 days'
      - '일주일'
    days_30:
      - '지난 30일'
      - '최근 30일'
      - '최근 한달'
      - 'last 30 days'
      - '한 달'
    days_1:
      - '어제'
      - 'yesterday'
      - '하루 전'
    weeks_1:
      - '이번주'
      - 'this week'
      - '금주'
    months_1:
      - '이번달'
      - 'this month'
      - '이달'
      - '금월'

  # 그룹핑 키워드
  group_by:
    device_category:
      - '디바이스별'
      - '기기별'
      - 'device'
      - '디바이스'
    source_medium:
      - '채널별'
      - '소스별'
      - 'channel'
      - 'source'
      - '유입경로별'
    hour:
      - '시간대별'
      - '시간별'
      - 'hour'
      - '시각별'
    date:
      - '일별'
      - '날짜별'
      - 'daily'
      - '데일리'

  # 필터 키워드
  filters:
    device_mobile:
      - '모바일'
      - 'mobile'
      - '휴대폰'
    device_desktop:
      - '데스크톱'
      - 'desktop'
      - 'pc'
      - '컴퓨터'
    status_completed:
      - '완료'
      - 'completed'
      - '완료된'

  # 집계 단위 키워드
  grains:
    day:
      - '일별'
      - '하루'
      - 'daily'
      - '데일리'
    week:
      - '주별'
      - '주간'
      - 'weekly'
      - '위클리'
    month:
      - '월별'
      - '월간'
      - 'monthly'
      - '먼슬리'

# Planner 설정 (Query Planner Configuration)
planner_config:
  # 유효한 의도 목록
  valid_intents:
    - metric
    - metric_over_time
    - comparison
    - aggregation

  # 유효한 집계 단위 (Grain) 목록
  valid_grains:
    - day
    - week
    - month
    - hour

  # 글로벌 기본값
  defaults:
    metric: orders      # 기본 메트릭
    grain: day         # 기본 집계 단위

  # 의도별 최적 기본값
  intent_defaults:
    metric:
      grain: day       # 단순 메트릭은 일별
    metric_over_time:
      grain: day       # 시간 추이는 일별
    comparison:
      grain: month     # 비교는 월별이 적합
    aggregation:
      grain: day       # 집계는 일별
