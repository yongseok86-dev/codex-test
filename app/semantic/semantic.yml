# Placeholder semantic model (draft)
entities:
  - name: user
    grain: user_pseudo_id
    table: `proj.mall.users`
    dimensions:
      - name: user_pseudo_id
      - name: first_touch_date
        type: date
      - name: first_channel
        synonyms: [유입채널, 채널]
      - name: is_new_user
        type: boolean

  - name: session
    grain: session_id
    table: `proj.mall.sessions`
    relationships:
      - to: user
        type: many_to_one
        on: session.user_pseudo_id = user.user_pseudo_id
    dimensions:
      - name: session_id
      - name: session_date
        type: date
      - name: source_medium
      - name: campaign
      - name: device_category
      - name: landing_page
      - name: is_bounce
        type: boolean
    measures:
      - name: sessions
        expr: COUNT(DISTINCT session_id)
      - name: bounces
        expr: SUM(CASE WHEN is_bounce THEN 1 ELSE 0 END)

  - name: event
    grain: event_id
    table: `proj.mall.events`
    relationships:
      - to: session
        type: many_to_one
        on: event.session_id = session.session_id
      - to: user
        type: many_to_one
        on: event.user_pseudo_id = user.user_pseudo_id
    dimensions:
      - name: event_date
        type: date
      - name: event_name
      - name: page_path
      - name: item_id
      - name: event_value
        type: number
    measures:
      - name: events
        expr: COUNT(*)
      - name: add_to_cart
        expr: SUM(CASE WHEN event_name = 'add_to_cart' THEN 1 ELSE 0 END)
      - name: purchases
        expr: SUM(CASE WHEN event_name = 'purchase' THEN 1 ELSE 0 END)

  - name: order
    grain: order_id
    table: `proj.mall.orders`
    relationships:
      - to: user
        type: many_to_one
        on: order.user_pseudo_id = user.user_pseudo_id
      - to: session
        type: many_to_one
        on: order.session_id = session.session_id
    dimensions:
      - name: order_id
      - name: order_date
        type: date
      - name: status
        valid_values: [completed, cancelled, returned]
      - name: payment_method
      - name: channel
    measures:
      - name: orders
        expr: COUNT(DISTINCT order_id)
      - name: gmv
        expr: SUM(net_amount)
      - name: customers
        expr: COUNT(DISTINCT user_pseudo_id)

metrics:
  - name: sessions
    expr: COUNT(DISTINCT session.session_id)
  - name: users
    expr: COUNT(DISTINCT user.user_pseudo_id)
  - name: events
    expr: COUNT(*)
  - name: gmv
    expr: SUM(order.net_amount)
    default_filters: [order.status='completed']
  - name: orders
    expr: COUNT(DISTINCT order.order_id)
    default_filters: [order.status='completed']
  - name: conversion_rate
    expr: SAFE_DIVIDE(COUNT(DISTINCT order.order_id), COUNT(DISTINCT session.session_id))
    default_filters: [order.status='completed']
  - name: aov
    expr: SAFE_DIVIDE(SUM(order.net_amount), NULLIF(COUNT(DISTINCT order.order_id),0))
    default_filters: [order.status='completed']
  - name: bounce_rate
    expr: SAFE_DIVIDE(SUM(CASE WHEN session.is_bounce THEN 1 ELSE 0 END), COUNT(DISTINCT session.session_id))

vocabulary:
  synonyms:
    '구매': ['주문','order','purchase','결제']
    '매출': ['GMV','거래액','매출액']
    '세션': ['방문','session']
    '유입': ['첫방문','first_touch','first_channel']
    '장바구니': ['add_to_cart','장바']
    '이탈률': ['bounce_rate','바운스']
    '전환율': ['conversion','conversion_rate','전환']
  units:
    currency: KRW

# NLU 키워드 설정 (Natural Language Understanding)
nlu_keywords:
  # 의도(Intent) 키워드
  intents:
    comparison:
      - '비교'
      - '대비'
      - 'vs'
      - 'compare'
      - '차이'
    metric_over_time:
      - '추이'
      - 'trend'
      - 'over time'
      - '변화'
      - '흐름'
    aggregation:
      - '별'
      - '그룹'
      - 'group by'
      - '분류'
      - '구분'

  # 메트릭 키워드
  metrics:
    gmv:
      - '매출'
      - 'gmv'
      - '매출액'
      - 'revenue'
      - '거래액'
      - '취급액'
      - '매출금액'
      - '취급금액'
    orders:
      - '주문'
      - 'orders'
      - '주문건수'
      - '주문수'
      - '결제'
    sessions:
      - '세션'
      - '방문'
      - 'sessions'
      - 'visit'
      - '접속'
    users:
      - '사용자'
      - '유저'
      - 'users'
      - '방문자'
      - '고객'
      - '회원'
    events:
      - '이벤트'
      - 'events'
      - '클릭'
      - '액션'

  # 시간 범위 키워드
  time_windows:
    days_7:
      - '지난 7일'
      - '최근 7일'
      - 'last 7 days'
      - '일주일'
    days_30:
      - '지난 30일'
      - '최근 30일'
      - '최근 한달'
      - 'last 30 days'
      - '한 달'
    days_1:
      - '어제'
      - 'yesterday'
      - '하루 전'
    weeks_1:
      - '이번주'
      - 'this week'
      - '금주'
    months_1:
      - '이번달'
      - 'this month'
      - '이달'
      - '금월'

  # 그룹핑 키워드
  group_by:
    device_category:
      - '디바이스별'
      - '기기별'
      - 'device'
      - '디바이스'
    source_medium:
      - '채널별'
      - '소스별'
      - 'channel'
      - 'source'
      - '유입경로별'
    hour:
      - '시간대별'
      - '시간별'
      - 'hour'
      - '시각별'
    date:
      - '일별'
      - '날짜별'
      - 'daily'
      - '데일리'

  # 필터 키워드
  filters:
    device_mobile:
      - '모바일'
      - 'mobile'
      - '휴대폰'
    device_desktop:
      - '데스크톱'
      - 'desktop'
      - 'pc'
      - '컴퓨터'
    status_completed:
      - '완료'
      - 'completed'
      - '완료된'

  # 집계 단위 키워드
  grains:
    day:
      - '일별'
      - '하루'
      - 'daily'
      - '데일리'
    week:
      - '주별'
      - '주간'
      - 'weekly'
      - '위클리'
    month:
      - '월별'
      - '월간'
      - 'monthly'
      - '먼슬리'

# Planner 설정 (Query Planner Configuration)
planner_config:
  # 유효한 의도 목록
  valid_intents:
    - metric
    - metric_over_time
    - comparison
    - aggregation

  # 유효한 집계 단위 (Grain) 목록
  valid_grains:
    - day
    - week
    - month
    - hour

  # 글로벌 기본값
  defaults:
    metric: orders      # 기본 메트릭
    grain: day         # 기본 집계 단위

  # 의도별 최적 기본값
  intent_defaults:
    metric:
      grain: day       # 단순 메트릭은 일별
    metric_over_time:
      grain: day       # 시간 추이는 일별
    comparison:
      grain: month     # 비교는 월별이 적합
    aggregation:
      grain: day       # 집계는 일별

# GA4 BigQuery Export 스키마 정보
# 네스티드 필드 접근 시 dot notation 사용
ga4_schema:
  # 중요: GA4 테이블의 네스티드 필드는 반드시 dot notation 사용
  nested_fields:
    # Device 필드 (RECORD 타입)
    device:
      - category: "device.category"  # mobile | desktop | tablet
      - operating_system: "device.operating_system"  # Windows, iOS, Android
      - browser: "device.browser"  # Chrome, Safari, Firefox
      - language: "device.language"
      - mobile_brand_name: "device.mobile_brand_name"  # Samsung, Apple
      - mobile_model_name: "device.mobile_model_name"  # iPhone 13, Galaxy S21

    # Geo 필드 (RECORD 타입)
    geo:
      - continent: "geo.continent"  # Americas, Europe, Asia
      - country: "geo.country"  # KR, US, JP
      - region: "geo.region"
      - city: "geo.city"
      - metro: "geo.metro"

    # Traffic Source 필드 (RECORD 타입)
    traffic_source:
      - source: "traffic_source.source"  # google, facebook, direct
      - medium: "traffic_source.medium"  # organic, cpc, referral
      - name: "traffic_source.name"  # 캠페인명

    # E-commerce 필드 (RECORD 타입)
    ecommerce:
      - transaction_id: "ecommerce.transaction_id"
      - purchase_revenue: "ecommerce.purchase_revenue"
      - purchase_revenue_in_usd: "ecommerce.purchase_revenue_in_usd"
      - total_item_quantity: "ecommerce.total_item_quantity"

  # REPEATED 필드 (UNNEST 필요)
  repeated_fields:
    # Event Parameters (REPEATED RECORD)
    event_params:
      access: |
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'key_name')
      examples:
        - session_id: "(SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id')"
        - page_location: "(SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'page_location')"
        - page_title: "(SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'page_title')"

    # Items (REPEATED RECORD)
    items:
      access: "FROM table, UNNEST(items) AS item"
      fields:
        - item_id: "item.item_id"
        - item_name: "item.item_name"
        - price: "item.price"
        - quantity: "item.quantity"

  # 최상위 필드 (직접 접근)
  top_level:
    - event_date: "event_date"  # YYYYMMDD STRING
    - event_timestamp: "event_timestamp"  # INT64 마이크로초
    - event_name: "event_name"  # session_start, page_view, purchase
    - user_pseudo_id: "user_pseudo_id"
    - user_id: "user_id"
    - stream_id: "stream_id"
    - platform: "platform"  # WEB, IOS, ANDROID

  # 시간 변환 함수
  timestamp_functions:
    to_date: "DATE(TIMESTAMP_MICROS(event_timestamp))"
    to_datetime: "TIMESTAMP_MICROS(event_timestamp)"
    to_hour: "EXTRACT(HOUR FROM TIMESTAMP_MICROS(event_timestamp))"

# 일반적인 차원 매핑 (LLM 프롬프트용)
common_dimensions:
  디바이스: "device.category"
  디바이스별: "device.category"
  기기: "device.category"
  OS: "device.operating_system"
  운영체제: "device.operating_system"
  브라우저: "device.browser"

  국가: "geo.country"
  지역: "geo.region"
  도시: "geo.city"

  채널: "traffic_source.medium"
  소스: "traffic_source.source"
  유입경로: "traffic_source.source"
  캠페인: "traffic_source.name"

  시간대: "EXTRACT(HOUR FROM TIMESTAMP_MICROS(event_timestamp))"
  날짜: "DATE(TIMESTAMP_MICROS(event_timestamp))"
  일자: "DATE(TIMESTAMP_MICROS(event_timestamp))"

# 주의사항
notes:
  - "GA4 테이블은 events_YYYYMMDD 또는 events_intraday_YYYYMMDD 형식"
  - "와일드카드 사용 시: events_* 와 _TABLE_SUFFIX 조건 함께 사용"
  - "event_timestamp는 INT64 마이크로초이므로 TIMESTAMP_MICROS() 변환 필수"
  - "RECORD 타입 필드는 반드시 dot notation 사용 (device.category)"
  - "REPEATED 필드는 UNNEST() 사용 필수 (event_params, items)"
  - "세션 ID는 event_params에서 추출: (SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id')"

